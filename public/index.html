<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Chat</title>
  <script src="server.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; margin: 0; }
    .chat { max-width: 700px; margin: auto; display: flex; flex-direction: column; height: 100vh; }
    header { padding: 10px; background: #222; display: flex; gap: 10px; }
    header input { flex: 1; padding: 6px; }
    header button { padding: 6px 12px; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
    .msg { background: #333; padding: 10px; border-radius: 8px; max-width: 70%; }
    .mine { align-self: flex-end; background: #444; }
    .meta { font-size: 12px; color: #aaa; margin-top: 4px; }
    form { display: flex; padding: 10px; background: #222; }
    form textarea { flex: 1; resize: none; padding: 8px; }
    form button { padding: 8px 12px; }
  </style>
</head>
<body>
  <div class="chat">
    <header>
      <input id="username" placeholder="Enter username" maxlength="24" />
      <button id="setName">Join</button>
    </header>

    <div id="messages"></div>

    <form id="chatForm">
      <textarea id="messageInput" placeholder="Type a message..." maxlength="1000"></textarea>
      <button type="submit">Send</button>
    </form>
  </div>

  <script>
    const socket = io();
    const messagesEl = document.getElementById('messages');
    const form = document.getElementById('chatForm');
    const input = document.getElementById('messageInput');
    const usernameInput = document.getElementById('username');
    const setNameBtn = document.getElementById('setName');

    // --- Load saved username ---
    let username = localStorage.getItem('username') || '';
    usernameInput.value = username;

    // --- Load saved chat history ---
    let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
    chatHistory.forEach(renderMessage);

    // --- Save username when set ---
    setNameBtn.addEventListener('click', () => {
      const val = usernameInput.value.trim();
      if (!val) return alert('Enter a username');
      username = val;
      localStorage.setItem('username', username);
    });

    // --- Send message ---
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      socket.emit('chat:send', { username: username || 'Anonymous', text });
      input.value = '';
    });

    // --- Receive message ---
    socket.on('chat:message', ({ username: name, text, time }) => {
      const msg = { username: name, text, time };
      renderMessage(msg);

      // Save to localStorage
      chatHistory.push(msg);
      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    });

    // --- Render message bubble ---
    function renderMessage({ username: name, text, time }) {
      const isMine = name === (username || 'Anonymous');
      const div = document.createElement('div');
      div.className = 'msg' + (isMine ? ' mine' : '');
      div.innerHTML = `
        <div class="text">${text}</div>
        <div class="meta">${name} â€¢ ${new Date(time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
      `;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  </script>
</body>
</html>
